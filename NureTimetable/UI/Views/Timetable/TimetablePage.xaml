<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:mct="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:fonts="clr-namespace:NureTimetable.UI.Models.Consts"
             xmlns:converters="clr-namespace:NureTimetable.UI.Converters"
             xmlns:dal="clr-namespace:NureTimetable.DAL.Settings;assembly=NureTimetable.DAL"
             xmlns:vm="clr-namespace:NureTimetable.UI.ViewModels"
             xmlns:sfs="clr-namespace:Syncfusion.Maui.Scheduler;assembly=Syncfusion.Maui.Scheduler"
             xmlns:ui="clr-namespace:NureTimetable.UI.Helpers"
             Shell.TabBarIsVisible="True"
             x:Class="NureTimetable.UI.Views.TimetablePage"
             x:DataType="vm:TimetableViewModel"
             Title="{Binding Title.Localized}">
    <ContentPage.Behaviors>
        <mct:EventToCommandBehavior x:DataType="vm:TimetableViewModel" EventName="Appearing" Command="{Binding PageAppearingCommand}"/>
        <mct:EventToCommandBehavior x:DataType="vm:TimetableViewModel" EventName="Disappearing" Command="{Binding PageDisappearingCommand}"/>
    </ContentPage.Behaviors>

    <ContentPage.ToolbarItems>
        <ToolbarItem x:DataType="vm:TimetableViewModel" IconImageSource="{Binding HideSelectedEventsIcon, Converter={converters:ToolbarIconValueConverter}}" Command="{Binding HideSelectedEventsCommand}" />
        <ToolbarItem x:DataType="vm:TimetableViewModel" IconImageSource="{FontImageSource FontFamily=MaterialDesignIcons, Glyph={Static fonts:MaterialIconsFont.CalendarToday}}" Command="{Binding ScheduleModeCommand}" />
        <ToolbarItem x:DataType="vm:TimetableViewModel" IconImageSource="{FontImageSource FontFamily=MaterialDesignIcons, Glyph={Static fonts:MaterialIconsFont.Sync}}" Command="{Binding UpdateTimetableCommand}" />
    </ContentPage.ToolbarItems>

    <RefreshView IsRefreshing="{Binding IsTimetableUpdating}">
        <AbsoluteLayout HorizontalOptions="FillAndExpand" VerticalOptions="FillAndExpand">
            <StackLayout AbsoluteLayout.LayoutBounds="0,0,1,1" 
                    AbsoluteLayout.LayoutFlags="All" 
                    BackgroundColor="{DynamicResource PageBackgroundColor}" 
                    IsVisible="{Binding TimetableInfoList.Events, Converter={mct:IsListNotNullOrEmptyConverter}}">
                <Grid Margin="0,15,0,0" IsVisible="{Binding IsTimeLeftVisible}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <Label Grid.Column="0" HorizontalOptions="Center" FontSize="20" Text="{Binding TimeLeftText}" />
                    <Image Grid.Column="1" 
                           Margin="0,0,10,0" 
                           IsVisible="{Binding DlNureUser, Source={Static dal:SettingsRepository.Settings}, Converter={mct:IsStringNullOrEmptyConverter}}" 
                           mct:TouchEffect.Command="{Binding AttendanceClickCommand}" 
                           Opacity="{Binding AttendanceOpacity}"
                           Source="{FontImageSource FontFamily=MaterialDesignIcons, Glyph={Static fonts:MaterialIconsFont.BadgeAccountAlertOutline}, Color={DynamicResource ListIconColor}}" 
                           mct:TouchEffect.NativeAnimation="True" 
                           mct:TouchEffect.NativeAnimationBorderless="True" />
                </Grid>
                <sfs:SfScheduler
                    x:Name="Timetable"
                    FirstDayOfWeek="Monday"
                    VerticalOptions="FillAndExpand"
                    BackgroundColor="{DynamicResource PageBackgroundColor}"
                    MinimumDateTime="{Binding TimetableMinDisplayDate}"
                    MaximumDateTime="{Binding TimetableMaxDisplayDate}"
                    AppointmentsSource="{Binding TimetableDataSource}"
                    IsEnabled="{Binding IsProgressLayoutVisible, Converter={mct:InvertedBoolConverter}}"
                    View="{Binding TimetableScheduleView}"
                    SelectedDate="{Binding TimetableSelectedDate}">
                    <sfs:SfScheduler.Behaviors>
                        <mct:EventToCommandBehavior EventName="Tapped" Command="{Binding TimetableCellTappedCommand}"/>
                        <mct:EventToCommandBehavior EventName="ViewChanged" Command="{Binding TimetableVisibleDatesChangedCommand2}"/>
                    </sfs:SfScheduler.Behaviors>
                    <sfs:SfScheduler.DaysView>
                        <sfs:SchedulerDaysView 
                            StartHour="{Binding TimetableStartHour}" 
                            EndHour="{Binding TimetableEndHour}" 
                            TimeInterval="{Binding TimetableTimeInterval}"
                            TimeFormat="HH:mm"
                            CurrentTimeIndicatorBrush="CornflowerBlue">
                            <sfs:SchedulerDaysView.ViewHeaderSettings>
                                <sfs:SchedulerViewHeaderSettings Background="{DynamicResource PageBackgroundColor}">
                                    <sfs:SchedulerViewHeaderSettings.DayTextStyle>
                                        <sfs:SchedulerTextStyle TextColor="{DynamicResource PrimaryTextColor}" FontSize="8" />
                                    </sfs:SchedulerViewHeaderSettings.DayTextStyle>
                                    <sfs:SchedulerViewHeaderSettings.DateTextStyle>
                                        <sfs:SchedulerTextStyle TextColor="{DynamicResource PrimaryTextColor}" FontSize="13" />
                                    </sfs:SchedulerViewHeaderSettings.DateTextStyle>
                                </sfs:SchedulerViewHeaderSettings>
                            </sfs:SchedulerDaysView.ViewHeaderSettings>
                        </sfs:SchedulerDaysView>
                    </sfs:SfScheduler.DaysView>
                    <sfs:SfScheduler.MonthView>
                        <sfs:SchedulerMonthView AppointmentDisplayMode="Text">
                            <sfs:SchedulerMonthView.CellStyle>
                                <sfs:SchedulerMonthCellStyle 
                                    LeadingMonthBackground="{DynamicResource PageBackgroundColor}"
                                    Background="{DynamicResource PageBackgroundColor}"
                                    TrailingMonthBackground="{DynamicResource PageBackgroundColor}"
                                    TodayBackground="{DynamicResource PageBackgroundColor}">
                                    <sfs:SchedulerMonthCellStyle.TextStyle>
                                        <sfs:SchedulerTextStyle TextColor="{DynamicResource PrimaryTextColor}" />
                                    </sfs:SchedulerMonthCellStyle.TextStyle>
                                    <sfs:SchedulerMonthCellStyle.LeadingMonthTextStyle>
                                        <sfs:SchedulerTextStyle TextColor="{DynamicResource TertiaryTextColor}" />
                                    </sfs:SchedulerMonthCellStyle.LeadingMonthTextStyle>
                                    <sfs:SchedulerMonthCellStyle.TrailingMonthTextStyle>
                                        <sfs:SchedulerTextStyle TextColor="{DynamicResource TertiaryTextColor}" />
                                    </sfs:SchedulerMonthCellStyle.TrailingMonthTextStyle>
                                </sfs:SchedulerMonthCellStyle>
                            </sfs:SchedulerMonthView.CellStyle>
                        </sfs:SchedulerMonthView>
                    </sfs:SfScheduler.MonthView>
                    <sfs:SfScheduler.AppointmentMapping>
                        <sfs:SchedulerAppointmentMapping
			                Subject="DisplayInfo"
			                StartTime="Start"
			                EndTime="End"
                            Background="Color"/>
                    </sfs:SfScheduler.AppointmentMapping>
                    <sfs:SfScheduler.AppointmentTextStyle>
                        <sfs:SchedulerTextStyle TextColor="{DynamicResource AppointmentTextColor}" />
                    </sfs:SfScheduler.AppointmentTextStyle>
                </sfs:SfScheduler>
            </StackLayout>
            <Button
                x:Name="BToday"
                HorizontalOptions="Center"
                AbsoluteLayout.LayoutFlags="PositionProportional"
                AbsoluteLayout.LayoutBounds="1,1,1,1"
                FontFamily="MaterialDesignIcons" 
                CornerRadius="100"
                FontSize="20"
                Margin="20"
                WidthRequest="47" 
                HeightRequest="47" 
                BackgroundColor="{DynamicResource CurrentDayColor}" 
                TextColor="White"
                IsVisible="{Binding TimetableInfoList.Events, Converter={mct:IsListNotNullOrEmptyConverter}}" 
                Scale="{Binding BTodayScale, Mode=TwoWay}"
                Command="{Binding BTodayClickedCommand}"
                Text="{Binding BTodayText}"/>
            <StackLayout AbsoluteLayout.LayoutBounds="0,0,1,1" 
                    AbsoluteLayout.LayoutFlags="All" 
                    VerticalOptions="CenterAndExpand" 
                    HorizontalOptions="CenterAndExpand"
                    Margin="5">
                <StackLayout.IsVisible>
                    <MultiBinding Converter="{mct:VariableMultiValueConverter ConditionType=All}">
                        <Binding Path="TimetableInfoList.Events" Converter="{mct:IsListNullOrEmptyConverter}" />
                        <Binding Path="IsProgressLayoutVisible" Converter="{mct:InvertedBoolConverter}" />
                    </MultiBinding>
                </StackLayout.IsVisible>
                <Label Text="{ui:Translate NoTimetable}" IsVisible="{Binding TimetableInfoList.Timetables, Converter={mct:IsListNullOrEmptyConverter}}"/>
                <Label Text="{ui:Translate TimetableIsEmpty}" IsVisible="{Binding TimetableInfoList.Timetables, Converter={mct:IsListNotNullOrEmptyConverter}}" />
            </StackLayout>
            <StackLayout IsVisible="{Binding IsProgressLayoutVisible}" Padding="12"
                    AbsoluteLayout.LayoutFlags="PositionProportional"
                    AbsoluteLayout.LayoutBounds="0.5,0.5,-1,-1">
                <ActivityIndicator IsRunning="True"/>
                <Label Text="{ui:Translate Wait}" HorizontalOptions="Center" TextColor="{DynamicResource ActivityIndicatorTextColor}"/>
            </StackLayout>
        </AbsoluteLayout>
    </RefreshView>
</ContentPage>